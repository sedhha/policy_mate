%%{init: {'theme': 'base', 'flowchart': {'curve': 'basis', 'padding': 20}}}%%
flowchart TD
    %% Data & Storage Layer
    subgraph dataLayer["ğŸ’¾ Data & Storage Architecture"]
        direction TB
        
        subgraph fileStorage["ğŸ“¦ File Storage"]
            S3["ğŸ“¦<br/>Amazon S3<br/><i>Document Repository</i>"]
            S3Policies["ğŸ“‹<br/>Policy Documents<br/><i>PDF, DOCX, TXT</i>"]
            S3Reports["ğŸ“Š<br/>Generated Reports<br/><i>Analysis Results</i>"]
            S3Backups["ğŸ’¾<br/>Backup Storage<br/><i>Versioned Files</i>"]
        end
        
        subgraph database["ğŸ—„ï¸ Database Services"]
            DynamoDB["ğŸ—„ï¸<br/>Amazon DynamoDB<br/><i>NoSQL Database</i>"]
            ComplianceControls["ğŸ“‹<br/>Compliance Controls<br/><i>PolicyMateComplianceControls</i>"]
            ConversationHistory["ğŸ’¬<br/>Conversation History<br/><i>PolicyMateConversationHistory</i>"]
            ComplianceReports["ğŸ“Š<br/>Compliance Reports<br/><i>PolicyMateComplianceReports</i>"]
            Files["ğŸ“„<br/>Files Metadata<br/><i>PolicyMateFiles</i>"]
            Organizations["ğŸ¢<br/>Organizations<br/><i>PolicyMateOrganizations</i>"]
            InferredFiles["ğŸ”<br/>Inferred Files<br/><i>PolicyMateInferredFiles</i>"]
        end
        
        subgraph searchEngine["ğŸ” Search & Analytics"]
            OpenSearch["ğŸ”<br/>Amazon OpenSearch<br/><i>Vector & Text Search</i>"]
            VectorIndex["ğŸ¯<br/>Vector Embeddings<br/><i>Semantic Search</i>"]
            TextIndex["ğŸ“„<br/>Full-Text Index<br/><i>Keyword Search</i>"]
            Analytics["ğŸ“ˆ<br/>Search Analytics<br/><i>Usage Metrics</i>"]
        end
    end

    %% Data Flow
    AIProcessing["ğŸ§  AI Processing"] -->|Stores Files| S3
    AIProcessing -->|Saves Metadata| DynamoDB
    AIProcessing -->|Indexes Content| OpenSearch
    
    S3 -->|Organizes| S3Policies
    S3 -->|Stores| S3Reports
    S3 -->|Maintains| S3Backups
    
    DynamoDB -->|Manages| ComplianceControls
    DynamoDB -->|Tracks| ConversationHistory
    DynamoDB -->|Stores| ComplianceReports
    DynamoDB -->|Records| Files
    DynamoDB -->|Maintains| Organizations
    DynamoDB -->|Stores| InferredFiles
    
    OpenSearch -->|Creates| VectorIndex
    OpenSearch -->|Maintains| TextIndex
    OpenSearch -->|Provides| Analytics
    
    %% RAG Workflow
    VectorIndex -.->|Semantic Queries| AIProcessing
    TextIndex -.->|Keyword Queries| AIProcessing
    Files -.->|Context Data| AIProcessing

    %% External Access
    UserInterface["ğŸ’» User Interface"] -->|Queries Data| OpenSearch
    UserInterface -->|Retrieves Files| S3
    UserInterface -->|Fetches Metadata| DynamoDB

    %% Styling
    classDef awsService fill:#ff9900,stroke:#232f3e,stroke-width:3px,color:#ffffff,font-weight:bold
    classDef storageNode fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#0d47a1,font-weight:bold
    classDef databaseNode fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#1b5e20,font-weight:bold
    classDef searchNode fill:#fce4ec,stroke:#c2185b,stroke-width:2px,color:#880e4f,font-weight:bold
    classDef externalNode fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#4a148c,font-weight:bold
    classDef layerBox fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#bf360c

    class S3,DynamoDB,OpenSearch awsService
    class S3Policies,S3Reports,S3Backups storageNode
    class ComplianceControls,ConversationHistory,ComplianceReports,Files,Organizations,InferredFiles databaseNode
    class VectorIndex,TextIndex,Analytics searchNode
    class AIProcessing,UserInterface externalNode
    class dataLayer,fileStorage,database,searchEngine layerBox

    %% Caption
    subgraph caption[" "]
        figureTitle["<b>Figure 4: Policy Mate Data & Storage Architecture</b>"]
        figureDesc["Comprehensive data architecture with S3 file storage, DynamoDB metadata management,<br/>and OpenSearch for advanced vector and text search capabilities supporting RAG workflows."]
    end

    classDef captionStyle fill:#f8f9fa,stroke:#dee2e6,stroke-width:1px,color:#495057,font-size:11px
    class caption,figureTitle,figureDesc captionStyle