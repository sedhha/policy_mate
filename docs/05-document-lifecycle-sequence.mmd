%%{init: {'theme': 'base', 'sequence': {'actorMargin': 50, 'width': 150, 'height': 65, 'boxMargin': 10, 'boxTextMargin': 5, 'noteMargin': 10, 'messageMargin': 35}}}%%
sequenceDiagram
    participant User as ðŸ‘¤ User
    participant UI as ðŸ’» Next.js UI
    participant Cognito as ðŸ” Amazon Cognito
    participant API as ðŸšª API Gateway
    participant UploadLambda as ðŸ“„ Upload Handler
    participant AgentLambda as ðŸ¤– Agent Handler
    participant Bedrock as ðŸ§  Amazon Bedrock
    participant ComplianceLambda as âœ… Compliance Check
    participant S3 as ðŸ“¦ Amazon S3
    participant DynamoDB as ðŸ—„ï¸ DynamoDB
    participant OpenSearch as ðŸ” OpenSearch

    %% Authentication Flow
    Note over User,Cognito: ðŸ” Authentication Phase
    User->>+UI: Login request
    UI->>+Cognito: Authenticate user
    Cognito-->>-UI: JWT Token
    UI-->>-User: Login successful

    %% Document Upload Flow
    Note over User,DynamoDB: ðŸ“„ Document Upload Phase
    User->>+UI: Upload policy document
    UI->>+API: POST /upload (with JWT)
    API->>+UploadLambda: Process file upload
    UploadLambda->>+S3: Store document
    S3-->>-UploadLambda: Storage confirmed
    UploadLambda->>+DynamoDB: Save metadata<br/>(PolicyMateFiles table)
    DynamoDB-->>-UploadLambda: Metadata saved
    UploadLambda-->>-API: Upload complete
    API-->>-UI: Success response
    UI-->>User: Upload confirmation

    %% Compliance Analysis Flow
    Note over User,OpenSearch: ðŸ” Compliance Analysis Phase
    User->>+UI: Request compliance analysis
    UI->>+API: POST /chat_session
    API->>+AgentLambda: Initialize analysis
    AgentLambda->>+Bedrock: Invoke Policy Mate Agent
    
    Note over Bedrock,ComplianceLambda: ðŸ¤– AI Orchestration
    Bedrock->>+ComplianceLambda: Tool call: compliance_check
    ComplianceLambda->>+DynamoDB: Query controls<br/>(PolicyMateComplianceControls)
    DynamoDB-->>-ComplianceLambda: Control data
    ComplianceLambda->>+OpenSearch: Vector search for context
    OpenSearch-->>-ComplianceLambda: Relevant documents
    ComplianceLambda->>+S3: Extract document text
    S3-->>-ComplianceLambda: Document content
    ComplianceLambda-->>-Bedrock: Compliance analysis results
    
    Bedrock-->>-AgentLambda: Final analysis & recommendations
    
    Note over AgentLambda,DynamoDB: ðŸ’¾ Results Storage
    AgentLambda->>+DynamoDB: Store compliance report<br/>(PolicyMateComplianceReports)
    DynamoDB-->>-AgentLambda: Report saved
    AgentLambda->>+DynamoDB: Save conversation<br/>(PolicyMateConversationHistory)
    DynamoDB-->>-AgentLambda: Conversation saved
    
    AgentLambda-->>-API: Analysis complete
    API-->>-UI: Compliance findings
    UI-->>User: Display compliance report

    %% Styling
    Note over User,OpenSearch: ðŸ“Š End-to-End Policy Compliance Workflow